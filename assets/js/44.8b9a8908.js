(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{567:function(s,a,t){"use strict";t.r(a);var n=t(4),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"_1-选举机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-选举机制"}},[s._v("#")]),s._v(" 1. 选举机制")]),s._v(" "),t("p",[s._v("半数机制")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://lskyimage-1306894954.cos.ap-nanjing.myqcloud.com/zk%2Fzk.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"_1-1-投票机制说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-投票机制说明"}},[s._v("#")]),s._v(" 1.1 投票机制说明")]),s._v(" "),t("p",[s._v("第一轮投票全部投给自己\n第二轮投票给myid比自己大的相邻节点，投票之前先判断自身的票数和其他节点的票数，如果得票超过半数，则选举结束，否则往下投票继续进行。")]),s._v(" "),t("h3",{attrs:{id:"_1-2-选举触发"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-选举触发"}},[s._v("#")]),s._v(" 1.2 选举触发")]),s._v(" "),t("p",[s._v("当集群中的服务器出现已下两种情况时会进行Leader的选举")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("服务节点初始化启动")]),s._v(" "),t("p",[s._v("当节点初始起动时会在集群中寻找Leader节点，如果找到则与Leader建立连接，其自身状态变化follower或observer。如果没有找到Leader，当前节点状态将变化LOOKING，进入选举流程。")])]),s._v(" "),t("li",[t("p",[s._v("半数以上的节点无法和Leader建立连接")]),s._v(" "),t("p",[s._v("在集群运行其间如果有follower或observer节点宕机只要不超过半数并不会影响整个集群服务的正常运行。但如果leader宕机，将暂停对外服务，所有follower将进入LOOKING 状态，进入选举流程。")])])]),s._v(" "),t("h2",{attrs:{id:"_2-数据同步机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-数据同步机制"}},[s._v("#")]),s._v(" 2. 数据同步机制")]),s._v(" "),t("p",[s._v("zookeeper 的数据同步是为了保证各节点中数据的一至性，同步时涉及两个流程:")]),s._v(" "),t("p",[s._v("一个是正常的客户端数据提交")]),s._v(" "),t("p",[s._v("一个是集群某个节点宕机在恢复后的数据同步。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://lskyimage-1306894954.cos.ap-nanjing.myqcloud.com/zk%2Fzk_sync.png",alt:""}})]),s._v(" "),t("p",[s._v("leader 接收客户端写请求，并同步给各个子节点（如上图）。但实际情况要复杂的多，比如client 它并不知道哪个")]),s._v(" "),t("p",[s._v("节点是leader 有可能写的请求会发给follower ，由follower在转发给leader进行同步处理，如下：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://lskyimage-1306894954.cos.ap-nanjing.myqcloud.com/zk%2Fzk_follow_sync.png",alt:""}})]),s._v(" "),t("p",[s._v("client向zk中的server发送写请求到达follower，follower则会将该写请求转发给leader，leader将请求事务以proposal形式分发给follower；")]),s._v(" "),t("p",[s._v("当follower收到收到leader的proposal时，根据接收的先后顺序处理proposal；")]),s._v(" "),t("p",[s._v("当Leader收到follower针对某个proposal过半的ack后，则发起事务提交，重新发起一个commit的proposal")]),s._v(" "),t("p",[s._v("Follower收到commit的proposal后，记录事务提交，并把数据更新到内存数据库；")]),s._v(" "),t("p",[s._v("当写成功后，反馈给client。")]),s._v(" "),t("h2",{attrs:{id:"_3-服务节点初始化以及同步"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-服务节点初始化以及同步"}},[s._v("#")]),s._v(" 3. 服务节点初始化以及同步")]),s._v(" "),t("p",[s._v("​\t在集群运行过程当中如果有一个follower节点宕机，由于宕机节点没过半，集群仍然能正常服务。当leader 收到新的客户端请求，此时无法同步给宕机的节点。造成数据不一至。为了解决这个问题，当节点启动时，第一件事情就是找当前的Leader，比对数据是否一至。不一至则开始同步,同步完成之后在进行对外提供服务。 如何比对Leader的数据版本呢，这里通过ZXID事务ID来确认。")]),s._v(" "),t("p",[s._v("​\tZXID是一个长度64位的数字，其中低32位是按照数字递增，任何数据的变更都会导致,低32位的数字简单加1。高32位是leader周期编号，每当选举出一个新的leader时，新的leader就从本地事物日志中取出ZXID,然后解析出高32位的周期编号，进行加1，再将低32位的全部设置为0。这样就保证了每次新选举的leader后，保证了ZXID的唯一性而且是保证递增的。")]),s._v(" "),t("h2",{attrs:{id:"_4-四字运维命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-四字运维命令"}},[s._v("#")]),s._v(" 4. 四字运维命令")]),s._v(" "),t("p",[s._v("ZooKeeper响应少量命令。每个命令由四个字母组成。可通过telnet或nc向ZooKeeper发出命令。 这些命令默认是关闭的，需要配置4lw.commands.whitelist来打开，可打开部分或全部示例如下：")]),s._v(" "),t("p",[s._v("打开指定命令：")]),s._v(" "),t("p",[s._v("4lw.commands.whitelist=stat, ruok, conf, isro")]),s._v(" "),t("p",[s._v("打开全部：")]),s._v(" "),t("p",[s._v("4lw.commands.whitelist=*")]),s._v(" "),t("p",[s._v("安装 Netcat 工具，以使用 nc 命令")]),s._v(" "),t("p",[s._v("yum install -y nc")]),s._v(" "),t("p",[s._v("查看服务器及客户端连接状态")]),s._v(" "),t("p",[s._v("echo stat | nc localhost 2181 命令列表")]),s._v(" "),t("p",[s._v("conf：3.3.0中的新增功能：打印有关服务配置的详细信息。\n缺点：3.3.0中的新增功能：列出了连接到该服务器的所有客户端的完整连接/会话详细信息。包括有关已接收/已发送的数据包数量，会话ID，操作等待时间，最后执行的操作等信息。\ncrst：3.3.0中的新增功能：重置所有连接的连接/会话统计信息。\ndump：列出未完成的会话和临时节点。这仅适用于领导者。\nenvi：打印有关服务环境的详细信息\nruok：测试服务器是否以非错误状态运行。如果服务器正在运行，它将以imok响应。否则，它将完全不响应。响应“ imok”不一定表示服务器已加入仲裁，只是服务器进程处于活动状态并绑定到指定的客户端端口。使用“ stat”获取有关状态仲裁和客户端连接信息的详细信息。\nsrst：重置服务器统计信息。\nsrvr：3.3.0中的新功能：列出服务器的完整详细信息。\nstat：列出服务器和连接的客户端的简要详细信息。\nwchs：3.3.0中的新增功能：列出有关服务器监视的简要信息。\nwchc：3.3.0中的新增功能：按会话列出有关服务器监视的详细信息。这将输出具有相关监视（路径）的会话（连接）列表。请注意，根据手表的数量，此操作可能会很昂贵（即影响服务器性能），请小心使用。\ndirs：3.5.1中的新增功能：以字节为单位显示快照和日志文件的总大小\nwchp：3.3.0中的新增功能：按路径列出有关服务器监视的详细信息。这将输出具有关联会话的路径（znode）列表。请注意，根据手表的数量，此操作可能会很昂贵（即影响服务器性能），请小心使用。\nmntr：3.4.0中的新增功能：输出可用于监视集群运行状况的变量列表。")]),s._v(" "),t("h2",{attrs:{id:"_5-常用命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-常用命令"}},[s._v("#")]),s._v(" 5. 常用命令")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("命令基本语法")]),s._v(" "),t("th",[s._v("功能描述")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("help")]),s._v(" "),t("td",[s._v("显示所有操作命令")])]),s._v(" "),t("tr",[t("td",[s._v("ls path")]),s._v(" "),t("td",[s._v("使用 ls 命令来查看当前znode的子节点-w  监听子节点变化-s   附加次级信息")])]),s._v(" "),t("tr",[t("td",[s._v("create")]),s._v(" "),t("td",[s._v("普通创建-s  含有序列-e  临时（重启或者超时消失）")])]),s._v(" "),t("tr",[t("td",[s._v("get path")]),s._v(" "),t("td",[s._v("获得节点的值-w  监听节点内容变化-s   附加次级信息")])]),s._v(" "),t("tr",[t("td",[s._v("set")]),s._v(" "),t("td",[s._v("设置节点的具体值")])]),s._v(" "),t("tr",[t("td",[s._v("stat")]),s._v(" "),t("td",[s._v("查看节点状态")])]),s._v(" "),t("tr",[t("td",[s._v("delete")]),s._v(" "),t("td",[s._v("删除节点")])]),s._v(" "),t("tr",[t("td",[s._v("deleteall")]),s._v(" "),t("td",[s._v("递归删除节点")])])])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -s /\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /kafka\ncreate /sanguo "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"diaochan"')]),s._v("\nget /sanguo\nget -s /sanguo\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建临时节点，下次进入则已删除")]),s._v("\ncreate -e /sanguo/wuguo\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建自带序号的节点")]),s._v("\ncreate -s /sanguo/weiguo "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kk"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改节点属性值")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" /sanguo/weiguo "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 节点的值变化监听")]),s._v("\nget -w /sanguo\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 节点的子节点变化监听（路径变化）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -w /sanguo\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除节点")]),s._v("\ndelete /sanguo/jin\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 递归删除")]),s._v("\ndeleteall /sanguo/shuguo\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 节点状态")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stat")]),s._v(" /sanguo\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("增\ncreate path\ncreate path "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'数据'")]),s._v("\ncreate -s path 带序号节点\ncreate -e path 临时节点\n查\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" path  查看子节点的内容\nget  path 获取当前节点的值\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -s  path 查看子节点的内容并获取当前节点的结构体\nget -s  path 获取当前节点的值并获取当前节点的结构体\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stat")]),s._v(" path 获取当前节点的结构体\n改\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" path "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'数据'")]),s._v(" 修改节点的值\n删\ndelete path 删除非空\ndeleteall path 强制删除\n------------------------\n特殊的 监听\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -w path   查看子节点并监听\nget -w path  查看节点的值并监听\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);