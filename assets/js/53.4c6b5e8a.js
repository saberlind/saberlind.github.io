(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{575:function(s,a,t){"use strict";t.r(a);var n=t(4),r=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"_1-flink基础架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-flink基础架构"}},[s._v("#")]),s._v(" 1. Flink基础架构")]),s._v(" "),t("p",[s._v("​\tFlink程序在运行时主要有TaskManager，JobManager，Client三种角色。")]),s._v(" "),t("p",[s._v("​\tJobManager是集群的老大，负责接收Flink Job，协调检查点，Failover 故障恢复等，同时管理TaskManager。 JobManager 包含：Dispatcher、ResourceManager、JobMaster。")]),s._v(" "),t("p",[s._v("​\tTaskManager是执行计算的节点，每个TaskManager负责管理其所在节点上的资源信息，如内存、磁盘、网络。内部划分slot隔离内存，不隔离cpu。同一个slot共享组的不同算子的subtask可以共享slot。")]),s._v(" "),t("p",[s._v("​\tClient是Flink程序提交的客户端，将Flink Job提交给JobManager。")]),s._v(" "),t("h2",{attrs:{id:"_2-flink和sparkstreaming"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-flink和sparkstreaming"}},[s._v("#")]),s._v(" 2. Flink和SparkStreaming")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th"),s._v(" "),t("th",[t("strong",[s._v("Flink")])]),s._v(" "),t("th",[t("strong",[s._v("Spark Streaming")])])])]),s._v(" "),t("tbody",[t("tr",[t("td",[t("strong",[s._v("计算模型")])]),s._v(" "),t("td",[s._v("流计算")]),s._v(" "),t("td",[s._v("微批次")])]),s._v(" "),t("tr",[t("td",[t("strong",[s._v("时间语义")])]),s._v(" "),t("td",[s._v("三种")]),s._v(" "),t("td",[s._v("没有，处理时间")])]),s._v(" "),t("tr",[t("td",[t("strong",[s._v("乱序")])]),s._v(" "),t("td",[s._v("有")]),s._v(" "),t("td",[s._v("没有")])]),s._v(" "),t("tr",[t("td",[t("strong",[s._v("窗口")])]),s._v(" "),t("td",[s._v("多、灵活")]),s._v(" "),t("td",[s._v("少、不灵活（窗口长度必须是 批次的整数倍）")])]),s._v(" "),t("tr",[t("td",[t("strong",[s._v("checkpoint")])]),s._v(" "),t("td",[s._v("异步分界线快照")]),s._v(" "),t("td",[s._v("弱")])]),s._v(" "),t("tr",[t("td",[t("strong",[s._v("状态")])]),s._v(" "),t("td",[s._v("有，多")]),s._v(" "),t("td",[s._v("没有（updatestatebykey）")])]),s._v(" "),t("tr",[t("td",[t("strong",[s._v("流式sql")])]),s._v(" "),t("td",[s._v("有")]),s._v(" "),t("td",[s._v("没有")])])])]),s._v(" "),t("h2",{attrs:{id:"_3-flink提交作业流程及核心概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-flink提交作业流程及核心概念"}},[s._v("#")]),s._v(" 3. Flink提交作业流程及核心概念")]),s._v(" "),t("p",[s._v("run-Applicaiton\n-d 后台运行（断开与客户端连接）\n-m 指定JobManager\n-c 指定全类名\n-D 如果要指定其他配置，可以跟在—D后面 格式：（-D参数名=参数值）\n-t 指定以yarn的什么模式来提交作业 yarn-pro-job  yarn-session yarn-application\n-p 提交任务时指定并行度")]),s._v(" "),t("p",[s._v("1）Flink提交流程（Yarn-Per-Job）")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://lskyimage-1306894954.cos.ap-nanjing.myqcloud.com/flink%2Fsummary%2Fflink_yarn_job.png",alt:""}})]),s._v(" "),t("p",[s._v("2）算子链路：Operator Chain")]),s._v(" "),t("p",[s._v("Flink自动做的优化，要求One-to-one，并行度相同。")]),s._v(" "),t("p",[s._v("代码disableOperatorChaining()禁用算子链。")]),s._v(" "),t("p",[s._v("3）Graph生成与传递")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th"),s._v(" "),t("th",[t("strong",[s._v("在哪里生成")])]),s._v(" "),t("th",[t("strong",[s._v("传递给谁")])]),s._v(" "),t("th",[t("strong",[s._v("做了什么事")])])])]),s._v(" "),t("tbody",[t("tr",[t("td",[t("strong",[s._v("逻辑流图StreamGraph")])]),s._v(" "),t("td",[s._v("Client")]),s._v(" "),t("td",[s._v("Client")]),s._v(" "),t("td",[s._v("最初的DAG图")])]),s._v(" "),t("tr",[t("td",[t("strong",[s._v("作业流图JobGraph")])]),s._v(" "),t("td",[s._v("Client")]),s._v(" "),t("td",[s._v("JobManager")]),s._v(" "),t("td",[s._v("算子链路优化")])]),s._v(" "),t("tr",[t("td",[t("strong",[s._v("执行流图ExecutionGraph")])]),s._v(" "),t("td",[s._v("JobManager")]),s._v(" "),t("td",[s._v("JobManager")]),s._v(" "),t("td",[s._v("并行度的细化")])]),s._v(" "),t("tr",[t("td",[t("strong",[s._v("物理流图")])]),s._v(" "),t("td"),s._v(" "),t("td"),s._v(" "),t("td")])])]),s._v(" "),t("p",[s._v("4）Task、Subtask的区别")]),s._v(" "),t("p",[s._v("​\tSubtask：算子的一个并行实例。")]),s._v(" "),t("p",[s._v("​\tTask：Subtask运行起来之后，就叫Task。")]),s._v(" "),t("p",[s._v("5）并行度和Slot的关系")]),s._v(" "),t("p",[s._v("​\tSlot是静态的概念，是指TaskMangaer具有的并发执行能力。")]),s._v(" "),t("p",[s._v("​\t并行度是动态的概念，指程序运行时实际使用的并发能力。")]),s._v(" "),t("p",[s._v("​\t设置合适的并行度能提高运算效率，太多太少都不合适。")]),s._v(" "),t("p",[s._v("6）Slot共享组了解吗，如何独享Slot插槽")]),s._v(" "),t("p",[s._v("​\tFlink默认是允许slot共享的，如果希望某个算子对应的任务完全独占一个slot，或者只有某一部分算子共享slot，我们也可以通过设置“slot共享组”手动指定：")]),s._v(" "),t("p",[t("code",[s._v('.map(word -> Tuple2.of(word, 1L)).slotSharingGroup("1");')])]),s._v(" "),t("p",[s._v("​\t这样，只有属于同一个slot共享组的子任务，才会开启slot共享；")]),s._v(" "),t("p",[s._v("​\t不同组之间的任务是完全隔离的，必须分配到不同的slot上。")]),s._v(" "),t("p",[s._v("​\t在这种场景下，总共需要的slot数量，就是各个slot共享组最大并行度的总和。")]),s._v(" "),t("h2",{attrs:{id:"_4-flink部署模式及区别"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-flink部署模式及区别"}},[s._v("#")]),s._v(" 4. Flink部署模式及区别")]),s._v(" "),t("p",[s._v("1）Local：本地模式，Flink作业在单个JVM进程中运行，适用于测试阶段")]),s._v(" "),t("p",[s._v("2）Standalone：Flink作业在一个专门的Flink集群上运行，独立模式不依赖于其他集群管理器（Yarn或者Kubernetes）")]),s._v(" "),t("p",[s._v("3）Yarn：")]),s._v(" "),t("p",[s._v("​\tPer-job：独享资源，代码解析在Client")]),s._v(" "),t("p",[s._v("​\tApplication：独享资源，代码解析在 JobMaster")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[s._v("Session：共享资源，一套集群多个job\n")])])]),t("p",[s._v("4）K8s：支持云原生，未来的趋势")]),s._v(" "),t("p",[s._v("5）Mesos：国外使用，仅作了解")]),s._v(" "),t("h2",{attrs:{id:"_5-flink任务的并行度"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-flink任务的并行度"}},[s._v("#")]),s._v(" 5. Flink任务的并行度")]),s._v(" "),t("p",[s._v("Flink任务的并行度优先级设置？资源一般如何配置？")]),s._v(" "),t("p",[s._v("设置并行度有多种方式，优先级：算子 > 全局Env > 提交命令行 > 配置文件")]),s._v(" "),t("p",[s._v("1）并行度根据任务设置：")]),s._v(" "),t("p",[s._v("（1）常规任务：Source，Transform，Sink算子都与Kafka分区保持一致")]),s._v(" "),t("p",[s._v("（2）计算偏大任务：Source，Sink算子与Kafka分区保持一致，Transform算子可设置成2的n次方，64，128…")]),s._v(" "),t("p",[s._v("2）资源设置：通用经验 1CU = 1CPU + 4G内存")]),s._v(" "),t("p",[s._v("Taskmanager的Slot数：1拖1（独享资源）、1拖N（节省资源，减少网络传输）")]),s._v(" "),t("p",[s._v("TaskManager的内存数：4~8G")]),s._v(" "),t("p",[s._v("TaskManager的CPU：Flink默认一个Slot分配一个CPU")]),s._v(" "),t("p",[s._v("JobManager的内存：2~4G")]),s._v(" "),t("p",[s._v("JobManager的CPU：默认是1")]),s._v(" "),t("p",[s._v("flink-conf.yaml：taskmanager.numberOfTaskSlots（参数设置一个 task 的 slot 数量）")]),s._v(" "),t("p",[s._v("3）资源是否足够：")]),s._v(" "),t("p",[s._v("资源设置，然后压测，看每个并行度处理上限，是否会出现反压")]),s._v(" "),t("p",[s._v("例如：每个并行度处理5000/s，开始出现反压，比如我们设置三个并行度，我们程序处理上限15000/s")]),s._v(" "),t("h2",{attrs:{id:"_6-flink的三种时间语义"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-flink的三种时间语义"}},[s._v("#")]),s._v(" 6. Flink的三种时间语义")]),s._v(" "),t("p",[s._v("事件时间Event Time：是事件创建的时间。数据本身携带的时间。")]),s._v(" "),t("p",[s._v("进入时间Ingestion Time：是数据进入Flink的时间。")]),s._v(" "),t("p",[s._v("处理时间Processing Time：是每一个执行基于时间操作的算子的本地系统时间，与机器相关，默认的时间属性就是Processing Time。")]),s._v(" "),t("h2",{attrs:{id:"_7-watermark"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-watermark"}},[s._v("#")]),s._v(" 7. Watermark")]),s._v(" "),t("p",[s._v("水位线是Flink流处理中保证结果正确性的核心机制，它往往会跟窗口一起配合，完成对乱序数据的正确处理。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("水位线是插入到"),t("strong",[s._v("数据流中的一个标记")]),s._v("，可以认为是一个"),t("strong",[s._v("特殊的数据")])])]),s._v(" "),t("li",[t("p",[s._v("水位线主要的内容是一个"),t("strong",[s._v("时间戳")]),s._v("，用来"),t("strong",[s._v("表示当前事件时间的进展")])])]),s._v(" "),t("li",[t("p",[s._v("水位线是"),t("strong",[s._v("基于数据的时间戳生成的")])])]),s._v(" "),t("li",[t("p",[s._v("水位线的时间戳必须"),t("strong",[s._v("单调递增")]),s._v("，以确保任务的事件时间时钟一直向前推进")])]),s._v(" "),t("li",[t("p",[s._v("水位线可以通过"),t("strong",[s._v("设置延迟")]),s._v("，来保证正确"),t("strong",[s._v("处理乱序")]),s._v("数据")])]),s._v(" "),t("li",[t("p",[s._v("一个水位线Watermark(t)，表示在当前流中事件时间已经达到了时间戳t，"),t("strong",[s._v("这代表 t 之前的所有数据都到齐了，之后流中不会出现时间戳"),t("code",[s._v("t' ≤ t")]),s._v("的数据")])])])]),s._v(" "),t("h2",{attrs:{id:"_8-watermark多并行度下的传递、生成原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-watermark多并行度下的传递、生成原理"}},[s._v("#")]),s._v(" 8. Watermark多并行度下的传递、生成原理")]),s._v(" "),t("p",[s._v("1）分类：")]),s._v(" "),t("p",[s._v("​\t间歇性：来一条数据，更新一次Watermark。")]),s._v(" "),t("p",[s._v("​\t周期性：固定周期更新Watermark。")]),s._v(" "),t("p",[s._v("​\t官方提供的API是基于周期的，默认200ms，因为间歇性会给系统带来压力。")]),s._v(" "),t("p",[s._v("2）生成原理：")]),s._v(" "),t("p",[s._v("​\tWatermark = 当前最大事件时间 - 乱序时间 - 1ms")]),s._v(" "),t("p",[s._v("3）传递：")]),s._v(" "),t("p",[s._v("​\tWatermark是一条携带时间戳的特殊数据，从代码指定生成的位置，插入到流里面。")]),s._v(" "),t("p",[s._v("​\t一对多：广播。")]),s._v(" "),t("p",[s._v("​\t多对一：取最小。")]),s._v(" "),t("p",[s._v("​\t多对多：拆分来看，其实就是上面两种的结合。")]),s._v(" "),t("h2",{attrs:{id:"_9-flink处理乱序和迟到数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_9-flink处理乱序和迟到数据"}},[s._v("#")]),s._v(" 9. Flink处理乱序和迟到数据")]),s._v(" "),t("p",[s._v("​\t在Apache Flink中，迟到时间（lateness）和乱序时间（out-of-orderness）是两个与处理时间和事件时间相关的概念。它们在流处理过程中，尤其是在处理不按事件时间排序的数据时非常重要。")]),s._v(" "),t("p",[s._v("（1）迟到时间（lateness）：迟到时间可以影响窗口，在窗口计算完成后，仍然可以接收迟到的数据")]),s._v(" "),t("p",[s._v("​\t迟到时间是指事件到达流处理系统的延迟时间，即事件的实际接收时间与其事件时间的差值。在某些场景下，由于网络延迟、系统故障等原因，事件可能会延迟到达。为了处理这些迟到的事件，Flink提供了一种机制，允许在窗口计算完成后仍然接受迟到的数据。设置迟到时间后，Flink会在窗口关闭之后再等待一段时间，以便接收并处理这些迟到的事件。")]),s._v(" "),t("p",[s._v("设置迟到时间的方法如下：")]),s._v(" "),t("p",[s._v("在定义窗口时，使用"),t("code",[s._v("allowedLateness")]),s._v("方法设置迟到时间。例如，设置迟到时间为10分钟：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DataStream")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" input "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ninput\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("keyBy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("key selector"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("window")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("window assigner"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("allowedLateness")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Time")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("minutes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("window function"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("（2）乱序时间（out-of-orderness）")]),s._v(" "),t("p",[s._v("乱序时间是通过影响水印来影响数据的摄入，它表示的是数据的混乱程度。")]),s._v(" "),t("p",[s._v("乱序时间是指事件在流中不按照事件时间的顺序到达。在某些场景下，由于网络延迟或数据源的特性，事件可能会乱序到达。")]),s._v(" "),t("p",[s._v("Flink提供了处理乱序事件的方法，即水位线（watermark）。")]),s._v(" "),t("p",[s._v("水位线是一种表示事件时间进展的机制，它告诉系统当前处理到哪个事件时间。当水位线到达某个值时，说明所有时间戳小于该值的事件都已经处理完成。为了处理乱序事件，可以为水位线设置一个固定的延迟。")]),s._v(" "),t("p",[s._v("设置乱序时间的方法如下：")]),s._v(" "),t("p",[s._v("在定义数据源时，使用"),t("code",[s._v("assignTimestampsAndWatermarks")]),s._v("方法设置水位线策略。例如，设置水位线延迟为5秒：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DataStream")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" input "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("addSource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("source"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ninput\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("assignTimestampsAndWatermarks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("WatermarkStrategy")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("forBoundedOutOfOrderness")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Duration")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ofSeconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("withTimestampAssigner")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("timestamp assigner"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("other operations"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h2",{attrs:{id:"_10-flink中的窗口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-flink中的窗口"}},[s._v("#")]),s._v(" 10. Flink中的窗口")]),s._v(" "),t("p",[s._v("Flink中的窗口（分类、生命周期、触发、划分）")]),s._v(" "),t("p",[s._v("1）窗口分类：")]),s._v(" "),t("p",[s._v("Keyed Window和Non-keyed Window")]),s._v(" "),t("p",[s._v("基于时间：滚动、滑动、会话。")]),s._v(" "),t("p",[s._v("基于数量：滚动、滑动。")]),s._v(" "),t("p",[s._v("2）Window口的4个相关重要组件：")]),s._v(" "),t("p",[s._v("assigner（分配器）：如何将元素分配给窗口。")]),s._v(" "),t("p",[s._v("function（计算函数）：为窗口定义的计算。其实是一个计算函数，完成窗口内容的计算。")]),s._v(" "),t("p",[s._v("triger（触发器）：在什么条件下触发窗口的计算。")]),s._v(" "),t("p",[s._v("evictor（退出器）：定义从窗口中移除数据。")]),s._v(" "),t("p",[s._v("触发器问题解决：")]),s._v(" "),t("p",[s._v("​\t可以使用自定义触发器，解决事件时间，没有数据到达，窗口不触发计算问题，还可以使用持续性触发器，实现一个窗口多次触发输出结果，详细看连接")]),s._v(" "),t("p",[s._v("问题展示：")]),s._v(" "),t("p",[s._v("https://www.bilibili.com/video/BV1Gv4y1H7F8/?spm_id_from=333.999.0.0&vd_source=891aa1a363111d4914eb12ace2e039af\n问题解决：")]),s._v(" "),t("p",[s._v("https://www.bilibili.com/video/BV1mM411N7uP/?spm_id_from=333.999.0.0&vd_source=891aa1a363111d4914eb12ace2e039af")]),s._v(" "),t("p",[s._v("3）窗口的划分：如，基于事件时间的滚动窗口")]),s._v(" "),t("p",[s._v("Start = 按照数据的事件时间向下取窗口长度的整数倍。")]),s._v(" "),t("p",[s._v("end = start + size")]),s._v(" "),t("p",[s._v("比如开了一个10s的滚动窗口，第一条数据是857s，那么它属于[850s,860s)。")]),s._v(" "),t("p",[s._v("4）窗口的创建：当属于某个窗口的第一个元素到达，Flink就会创建一个窗口，并且放入单例集合")]),s._v(" "),t("p",[s._v("5）窗口的销毁：时间进展 >= 窗口最大时间戳 + 窗口允许延迟时间\n（Flink保证只删除基于时间的窗口，而不能删除其他类型的窗口，例如全局窗口）。")]),s._v(" "),t("p",[s._v("6）窗口为什么左闭右开：属于窗口的最大时间戳 = end - 1ms")]),s._v(" "),t("p",[s._v("7）窗口什么时候触发：如基于事件时间的窗口 watermark >= end - 1ms")]),s._v(" "),t("blockquote",[t("p",[s._v("​\t其实, 在用window前首先需要确认应该是在keyBy后的流上用, 还是在没有keyBy的流上使用.")]),s._v(" "),t("p",[s._v("​\t在keyed streams上使用窗口, 窗口计算被并行的运用在多个task上, 可以认为每个分组都有自己单独窗口. 正如前面的代码所示.")]),s._v(" "),t("p",[s._v("​\t在non-keyed stream上使用窗口,无论并行度设置的是几窗口的并行度都是1, 所有的窗口逻辑只能在一个单独的task上执行.")]),s._v(" "),t("p",[t("code",[s._v(".windowAll(TumblingProcessingTimeWindows.of(Time.seconds(10)))")])]),s._v(" "),t("p",[s._v("需要注意的是: 非key分区的流, 即使把并行度设置为大于1 的数, 窗口也只能在某个分区上使用")])]),s._v(" "),t("h2",{attrs:{id:"_11-flink的keyby"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_11-flink的keyby"}},[s._v("#")]),s._v(" 11. Flink的keyby")]),s._v(" "),t("p",[s._v("Flink的keyby怎么实现分区？分区、分组的区别是什么？")]),s._v(" "),t("p",[s._v("把流中的数据分到不同的分区中.具有"),t("strong",[s._v("相同key的元素")]),s._v("会分到同一个分区中.一个分区中可以有多重不同的key.")]),s._v(" "),t("p",[s._v("在内部是使用的"),t("strong",[s._v("hash分区")]),s._v("来实现的.")]),s._v(" "),t("p",[s._v("分组与分区的区别：")]),s._v(" "),t("p",[s._v("​    分组： 是一个逻辑上的划分，按照key进行区分，经过 keyby，同一个分组的数据肯定会进入同一个分区")]),s._v(" "),t("p",[s._v("​    分区： 下游算子的一个并行实例（等价于一个slot），同一个分区内，可能有多个分组")]),s._v(" "),t("p",[s._v("注意：数据如果具有相同的 key 将一定去往同一个分组和分区，但是同一分区中的数据不一定属于同一组。")]),s._v(" "),t("h2",{attrs:{id:"_12-flink的intervajoin"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_12-flink的intervajoin"}},[s._v("#")]),s._v(" 12. Flink的Intervajoin")]),s._v(" "),t("p",[s._v("Flink的Interval Join的实现原理？Join不上的怎么办？")]),s._v(" "),t("p",[s._v("底层调用的是keyby + connect ，处理逻辑：")]),s._v(" "),t("p",[s._v("（1）判断是否迟到（迟到就不处理了，直接return）")]),s._v(" "),t("p",[s._v("（2）每条流都存了一个Map类型的状态（key是时间戳，value是List存数据）")]),s._v(" "),t("p",[s._v("（3）任一条流，来了一条数据，遍历对方的map状态，能匹配上就发往join方法")]),s._v(" "),t("p",[s._v("（4）使用定时器，超过有效时间范围，会删除对应Map中的数据（不是clear，是remove）")]),s._v(" "),t("p",[s._v("Interval join不会处理join不上的数据，如果需要没join上的数据，可以用 coGroup+join算子实现，或者直接使用flinksql里的left join或right join语法。")]),s._v(" "),t("h2",{attrs:{id:"_13-flink的状态编程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_13-flink的状态编程"}},[s._v("#")]),s._v(" 13. Flink的状态编程")]),s._v(" "),t("p",[s._v("（1）算子状态：作用范围是算子，算子的多个并行实例各自维护一个状态")]),s._v(" "),t("p",[s._v("（2）键控状态：每个分组维护一个状态")]),s._v(" "),t("p",[s._v("（3）状态后端：两件事 =》 本地状态存哪里、checkpoint存哪里")]),s._v(" "),t("p",[s._v("1.13版本之前")]),s._v(" "),t("div",{staticClass:"language-txt line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-txt"}},[t("code",[s._v("\t\t\t本地状态\t\t\t\tCheckpoint\n内存\t\t  TaskManager的内存\t\tJobManager内存\n文件\t\t  TaskManager的内存\t\tHDFS\nRocksDB\t\tRocksDB\t\t\t\t\tHDFS\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("1.13版本之后")]),s._v(" "),t("div",{staticClass:"language-txt line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-txt"}},[t("code",[s._v("\t\t\t \t 本地状态\n\nHashmap()        TaskManager的内存\n\nRocksDB          RocksDB\n\nCheckpoint存储    参数指定\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h2",{attrs:{id:"_14-flink端到端一致性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_14-flink端到端一致性"}},[s._v("#")]),s._v(" 14. Flink端到端一致性")]),s._v(" "),t("p",[s._v("端到端精确一次")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://lskyimage-1306894954.cos.ap-nanjing.myqcloud.com/flink%2Fsummary%2Fexactly_once.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"_15-flink分布式快照"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_15-flink分布式快照"}},[s._v("#")]),s._v(" 15. Flink分布式快照")]),s._v(" "),t("p",[s._v("​\tbarriers在数据流源处被注入并行数据流中。快照n的barriers被插入的位置（我们称之为Sn）是快照所包含的数据在数据源中最大位置。")]),s._v(" "),t("p",[s._v("​\t例如，在Kafka中，此位置将是分区中最后一条记录的偏移量。 将该位置Sn报告给checkpoint协调器（Flink的JobManager）。")]),s._v(" "),t("p",[s._v("​\t然后barriers向下游流动。当一个中间操作算子从其所有输入流中收到快照n的barriers时，它会为快照n发出barriers进入其所有输出流中。")]),s._v(" "),t("p",[s._v("​\t一旦Sink操作算子（流式DAG的末端）从其所有输入流接收到barriers n，它就向Checkpoint协调器确认快照n完成。")]),s._v(" "),t("p",[s._v("​\t在所有Sink确认快照后，意味快照着已完成。一旦完成快照n，Job将永远不再向数据源请求Sn之前的记录，因为此时这些记录（及其后续记录）将已经通过整个数据流拓扑，也即是已经被处理结束。")]),s._v(" "),t("h2",{attrs:{id:"_16-checkpoint的参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_16-checkpoint的参数"}},[s._v("#")]),s._v(" 16. Checkpoint的参数")]),s._v(" "),t("p",[s._v("（1）间隔：兼顾性能和延迟，一般任务设置分钟级（1~5min），要求延迟低的设置秒级")]),s._v(" "),t("p",[s._v("（2）Task重启策略（Failover）：")]),s._v(" "),t("p",[s._v("​\t固定延迟重启策略：重试几次、每次间隔多久。")]),s._v(" "),t("p",[s._v("​\t失败率重启策略：重试次数、重试区间、重试间隔。")]),s._v(" "),t("p",[s._v("​\t无重启策略：一般在开发测试时使用。")]),s._v(" "),t("p",[s._v("​\tFallback重启策略：默认固定延迟重启策略。")]),s._v(" "),t("h2",{attrs:{id:"_17-flink内存模型-重点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_17-flink内存模型-重点"}},[s._v("#")]),s._v(" 17. Flink内存模型(重点)")]),s._v(" "),t("p",[s._v("TaskManager")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://lskyimage-1306894954.cos.ap-nanjing.myqcloud.com/flink%2Fsummary%2Fflink_mem_model.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"_18-flink和维表join"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_18-flink和维表join"}},[s._v("#")]),s._v(" 18. Flink和维表join")]),s._v(" "),t("p",[s._v("（1）预加载：RickSyncFunc异步查询并关联，open()方法，查询维表，存储下来 ==》 定时查询")]),s._v(" "),t("p",[s._v("（2）热存储：存在外部系统Redis、HBase等")]),s._v(" "),t("p",[s._v("（3）广播维表")]),s._v(" "),t("p",[s._v("（4）Lookup Join：外部存储，connector创建，SQL用法")]),s._v(" "),t("h2",{attrs:{id:"_19-flinkcdc锁表问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_19-flinkcdc锁表问题"}},[s._v("#")]),s._v(" 19. FlinkCDC锁表问题")]),s._v(" "),t("p",[s._v("（1）FlinkCDC 1.x同步历史数据会锁表")]),s._v(" "),t("p",[s._v("​\t设置参数不加锁，但只能保证至少一次。")]),s._v(" "),t("p",[s._v("（2）2.x 实现了无锁算法，同步历史数据的时候不会锁表")]),s._v(" "),t("p",[s._v("​\t2.x在全量同步阶段可以多并行子任务同步，在增量阶段只能单并行子任务同步")]),s._v(" "),t("h2",{attrs:{id:"_20-优化-minibatch-local-global-反压"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_20-优化-minibatch-local-global-反压"}},[s._v("#")]),s._v(" 20. 优化(MiniBatch_Local-Global，反压)")]),s._v(" "),t("h3",{attrs:{id:"_1-minibatch-聚合"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-minibatch-聚合"}},[s._v("#")]),s._v(" 1. MiniBatch 聚合")]),s._v(" "),t("p",[s._v("flink默认是每一条数据都会取更新状态")]),s._v(" "),t("p",[s._v("MiniBatch ：缓存一批数据一起更新状态，优点：增加吞吐量，缺点：增加延迟-")]),s._v(" "),t("p",[s._v("开启 MiniBatch")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("-- sql中开启\n-- 开启\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" table.exec.mini-batch.enabled"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n-- 最大缓存时间\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" table.exec.mini-batch.allow-latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'5 s'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n-- 批次大小\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" table.exec.mini-batch.size"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h3",{attrs:{id:"_2-local-global聚合"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-local-global聚合"}},[s._v("#")]),s._v(" 2. Local-Global聚合")]),s._v(" "),t("p",[s._v("开启预聚合需要先开启MiniBatch")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("-- 开启预聚合\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" table.optimizer.agg-phase-strategy"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("TWO_PHASE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#示例"}},[s._v("#")]),s._v(" 示例")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("-- 删除表\ndrop table words"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n-- "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" 表\nCREATE TABLE words "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    word STRING\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" WITH "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'connector'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'datagen'")]),s._v(",\n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rows-per-second'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1000000'")]),s._v(", -- 每秒生成的数据行数据\n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'fields.word.length'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2'")]),s._v(" --字段长度限制\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("ol",[t("li",[s._v("生产数据的速度时50万每秒，下游消费数据的速度10万每秒 ---- 反压")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("-- 删除表\ndrop table blackhole_table"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n-- 黑洞\nCREATE TABLE blackhole_table "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    word STRING,\n    c BIGINT\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nWITH "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'connector'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'blackhole'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n-- 执行查询\ninsert into blackhole_table\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" word,count"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" as c from \nwords\ngroup by word\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("开启minibatch和预聚合")]),s._v(" "),t("p",[s._v("预聚合之后上游发送到数据下游数据量会减少，可以解决反压")]),s._v(" "),t("p",[s._v("flink内部已经没有发生反压了")]),s._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[s._v("将数据保存到mysql,写入数据的速度只能达到1600/s - 反压")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("--mysql sink\nCREATE TABLE word_count "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    word STRING,\n    c BIGINT,\n    PRIMARY KEY "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("word"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" NOT ENFORCED \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" WITH "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'connector'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'jdbc'")]),s._v(",\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'url'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'jdbc:mysql://master:3306/bigdata'")]),s._v(",\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'table-name'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'word_count'")]),s._v(",\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'username'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),s._v(",\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'password'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n \ninsert into word_count\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" word,count"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" as c from \nwords\ngroup by word\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("数据写入 mysql，增加批次大小，和提高并行度，可以解决反压")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("drop table word_count"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nCREATE TABLE word_count "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    word STRING,\n    c BIGINT,\n    PRIMARY KEY "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("word"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" NOT ENFORCED \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" WITH "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'connector'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'jdbc'")]),s._v(",\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'url'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'jdbc:mysql://master:3306/bigdata'")]),s._v(",\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'table-name'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'word_count'")]),s._v(",\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'username'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),s._v(",\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'password'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),s._v(",\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sink.buffer-flush.max-rows'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1000'")]),s._v(" ,-- 每批次最大值，会增加延迟\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sink.parallelism'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v(" --提高写入数据并行度，增加成本\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \ninsert into word_count\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" word,count"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" as c from \nwords\ngroup by word"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("数据写入 hbase")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("-- hbase sink\ndrop table hbase_word_count"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nCREATE TABLE hbase_word_count "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n word STRING,\n info ROW"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("c BIGINT"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(",\n PRIMARY KEY "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("word"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" NOT ENFORCED\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" WITH "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'connector'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hbase-1.4'")]),s._v(",\n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'table-name'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'word_count'")]),s._v(",\n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zookeeper.quorum'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'master:2181,node1:2181,node2:2181'")]),s._v(",\n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sink.parallelism'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v(", -- 写入数据并行度\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sink.buffer-flush.max-rows'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3000'")]),s._v("  -- 写入数据批次大小\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n--先再habse中创建表\ncreate  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'word_count'")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'info'")]),s._v("\n \n--- 将数据写入hbase\ninsert into hbase_word_count\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" word,ROW"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" as info from "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" word,count"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" as c from \n    words\n    group by word\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" as a\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("h2",{attrs:{id:"_21-反压"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_21-反压"}},[s._v("#")]),s._v(" 21. 反压")]),s._v(" "),t("p",[s._v("上游生产数据速度比下游消费数据速度要大，flink就会发生反压，反压会从下游向上游传播，直到sourcetask会降低拉取数据速度，避免flink任务执行报错")]),s._v(" "),t("h3",{attrs:{id:"_1-flink-内部反压"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-flink-内部反压"}},[s._v("#")]),s._v(" 1. Flink 内部反压")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("增加flink任务的并行度")]),s._v(" "),t("ul",[t("li",[s._v("增加并行度相当于就是增加资源，成本会增加")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("-- flink sql\nSET "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'parallelism.default'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("开启MiniBatch和预聚合")]),s._v(" "),t("ul",[t("li",[s._v("开启之后会增加延迟")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" table.exec.mini-batch.enabled"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n-- 最大缓存时间\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" table.exec.mini-batch.allow-latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'5 s'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n-- 批次大小\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" table.exec.mini-batch.size"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n-- 开启预聚合\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" table.optimizer.agg-phase-strategy"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("TWO_PHASE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"_2-将数据保存到外部系统"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-将数据保存到外部系统"}},[s._v("#")]),s._v(" 2. 将数据保存到外部系统")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("mysql")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("-- 每批次最大值，会增加延迟\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sink.buffer-flush.max-rows'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1000'")]),s._v(" \n--提高写入数据并行度，增加成本 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.12")]),s._v("版本不支持?"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sink.parallelism'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v(" \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"_3-hbase"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-hbase"}},[s._v("#")]),s._v(" 3. Hbase")]),s._v(" "),t("ul",[t("li",[s._v("flink查询hbase可以开启异步IO,lookup.async=true,只支持hbase2.2以上版本")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("-- 每批次最大值，会增加延迟\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sink.buffer-flush.max-rows'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1000'")]),s._v(" \n--提高写入数据并行度，增加成本\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sink.parallelism'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v(" \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])])}),[],!1,null,null,null);a.default=r.exports}}]);